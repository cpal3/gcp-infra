# Reusable Terraform Workflow
# This file contains the shared logic for running Terraform in a specific directory.
# It is called by the main orchestrator.

name: "Terraform Module"

on:
  workflow_call:
    inputs:
      directory:
        description: 'The directory to run Terraform in'
        required: true
        type: string
      environment:
        description: 'The environment name'
        required: true
        type: string
      service_account:
        description: 'The service account to use for Terraform'
        required: true
        type: string
      pre_run_sleep:
        description: 'Duration to sleep before running (to wait for IAM propagation)'
        required: false
        type: number
        default: 0
    secrets:
      ORG_ID:
        required: true
      BILLING_ACCOUNT:
        required: true
      PROJECT_NAME:
        required: true
      REGION:
        required: true
      GITHUB_REPO:
        required: true
    outputs:
      applied:
        description: 'Whether terraform apply was executed'
        value: ${{ jobs.terraform.outputs.applied }}

jobs:
  terraform:
    name: "Run - ${{ inputs.directory }}"
    runs-on: ubuntu-latest
    outputs:
      applied: ${{ steps.apply.outputs.applied || 'false' }}
    
    permissions:
      contents: 'read'
      id-token: 'write'

    env:
      TF_VAR_org_id: ${{ secrets.ORG_ID }}
      TF_VAR_billing_account: ${{ secrets.BILLING_ACCOUNT }}
      TF_VAR_project_name: ${{ secrets.PROJECT_NAME }}
      TF_VAR_region: ${{ secrets.REGION }}
      TF_VAR_github_repo: ${{ secrets.GITHUB_REPO }}

    defaults:
      run:
        working-directory: ${{ inputs.directory }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for IAM Propagation
        if: inputs.pre_run_sleep > 0
        run: sleep ${{ inputs.pre_run_sleep }}

      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - '${{ inputs.directory }}/**'
              - 'modules/**'

      - name: Authenticate to Google Cloud
        if: steps.changes.outputs.changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/671995239099/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
          service_account: ${{ inputs.service_account }}

      - name: Setup Terraform
        if: steps.changes.outputs.changed == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.0

      - name: Terraform Init
        if: steps.changes.outputs.changed == 'true'
        run: terraform init

      - name: Terraform Plan
        if: steps.changes.outputs.changed == 'true'
        run: terraform plan -input=false

      - name: Terraform Apply
        id: apply
        if: steps.changes.outputs.changed == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          terraform apply -auto-approve -input=false
          echo "applied=true" >> $GITHUB_OUTPUT
