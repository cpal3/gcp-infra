# Terraform Orchestrator Pipeline
# This file defines the execution order and calls reusable workflows.

name: "Terraform Orchestrator"

concurrency:
  group: terraform-deployment
  cancel-in-progress: false

on:
  push:
    branches:
      - main
    paths:
      - 'bootstrap/**'
      - 'foundation/**'
      - 'modules/**'
  pull_request:
    branches:
      - main
    paths:
      - 'bootstrap/**'
      - 'foundation/**'
      - 'modules/**'

jobs:
  bootstrap:
    name: "Bootstrap"
    permissions:
      contents: 'read'
      id-token: 'write'
    uses: ./.github/workflows/terraform-module.yaml
    with:
      directory: 'bootstrap'
      environment: 'bootstrap'
    secrets:
      ORG_ID: ${{ secrets.TF_VAR_ORG_ID }}
      BILLING_ACCOUNT: ${{ secrets.TF_VAR_BILLING_ACCOUNT }}
      PROJECT_NAME: ${{ secrets.TF_VAR_PROJECT_NAME }}
      REGION: ${{ secrets.TF_VAR_REGION }}
      GITHUB_REPO: ${{ secrets.TF_VAR_GITHUB_REPO }}

  foundation:
    name: "Foundation"
    needs: bootstrap
    permissions:
      contents: 'read'
      id-token: 'write'
    uses: ./.github/workflows/terraform-module.yaml
    with:
      directory: 'foundation'
      environment: 'foundation'
      # Only sleep if bootstrap actually applied changes
      pre_run_sleep: ${{ needs.bootstrap.outputs.applied == 'true' && 60 || 0 }}
    secrets:
      ORG_ID: ${{ secrets.TF_VAR_ORG_ID }}
      BILLING_ACCOUNT: ${{ secrets.TF_VAR_BILLING_ACCOUNT }}
      PROJECT_NAME: ${{ secrets.TF_VAR_PROJECT_NAME }}
      REGION: ${{ secrets.TF_VAR_REGION }}
      GITHUB_REPO: ${{ secrets.TF_VAR_GITHUB_REPO }}
